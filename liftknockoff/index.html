<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Lift Knock Off</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC9sQaGQMUn1TEZG3C11LjRlpQAppS4WGk" async defer></script>
    <link rel="stylesheet" href="style.css" type="text/css" />

    <script>    
        geo = navigator.geolocation;
        var lat = 999999;
        var lng = -999999;

        var request = new XMLHttpRequest(); 
        var rides;
        var map;
        
        function getLocation(){

            request.open("POST","https://hans-moleman.herokuapp.com/rides", true);

            navigator.geolocation.getCurrentPosition(function(somePos){
                lat = somePos.coords.latitude;
                lng = somePos.coords.longitude; 
                //printLocation();
                var params = "username=UdtR6A4Z&lat=" + lat + "&lng=" + lng;
                init_map();
                request.setRequestHeader("Content-type","application/x-www-form-urlencoded");
                request.send(params);
                
            });
            request.onreadystatechange = function() {
                if (request.readyState == 4 && request.status == 200) {
                    data = request.responseText;
                    //console.log(data);
                    rides = JSON.parse(data);
                    initialize_markers();
                }   
                else if (request.readyState == 4 && request.status != 200) {
                    document.getElementById("location").innerHTML = 
                    "<p>Whoops, something went terribly wrongo</p>";
                } 
                
            }
            
        }
       /* function printLocation(){
            elem = document.getElementById("location");
            elem.innerHTML ='<p class="fun">' + lat + ", " + lng + "</p>";
        }
        */
        function init_map(){
            console.log("inside init map");
            // assigning user location to landmark
            var userLandmark = new google.maps.LatLng(lat,lng);
            // setting up map
            var myOptions = {
                zoom: 12,
                center: userLandmark,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            // Create the map in the "map" <div>
            var map = new google.maps.Map(document.getElementById("map"), 
                                                    myOptions);
            // creating marker
            var marker = new google.maps.Marker({
                position: userLandmark,
                title: "You"
            });
            marker.setMap(map);
            // This is a global info window...
            var infowindow = new google.maps.InfoWindow();
            
            // Open info window on click of marker
            google.maps.event.addListener(marker, 'click', function() {
                infowindow.setContent(marker.title);
                infowindow.open(map, marker);
            });
        }
        
        function initialize_markers(){
            console.log("rides is " + rides);
            if (rides.passengers != undefined){
                items = rides.passengers;
                status = "passenger";
            }
            else{
                items = rides.vehicles;
                status = "driver";
            }
            for (i = 0; i < items.length; i++){
                lat = items[i].lat;
                lng = items[i].lng;
                console.log("lat is " + lat + " lng is "+ lng);
                var landmark = new google.maps.LatLng(lat,lng);
                var marker = new google.maps.Marker({
                    position: landmark,
                    title: status
                });
                marker.setMap(map);
                // This is a global info window...
                var infowindow = new google.maps.InfoWindow();
                
                // Open info window on click of marker
                google.maps.event.addListener(marker, 'click', function() {
                    infowindow.setContent(this.content);
                    infowindow.open(map, this);
                });   
            }  
        } 
        </script>
</head>

<body onload="getLocation()">
    <p id ="location"></p>
    <div id = "map"></div>
</body>
</html>	